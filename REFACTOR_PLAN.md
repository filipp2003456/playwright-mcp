## Рефакторинг Playwright MCP для встроенного сетевого мониторинга

### 0. Зачем всё это вообще
* Цель: агент в Cursor должен уверенно управлять браузером через Playwright **и при необходимости прямо в ходе сценария получать сетевые логи**, чтобы можно было «подключить парс» без танцев.
* Базовый `@playwright/mcp@latest` с задачей управления справляется: навигация, клики, формы — всё ок, но **никаких HTTP-записей** он не отдаёт.
* Чтобы закрыть дырку с логами, был собран отдельный MCP сервер `playwright-network-monitor`, который слушает CDP и складывает запросы в `RequestStorage`.
* На практике «двухсерверная» схема не взлетела: Cursor держит браузер внутри Playwright MCP, а Network Monitor так и не смог к нему прицепиться.

### 1. Исходная проблема и контекст
* В Cursor используется официальный MCP сервер `@playwright/mcp@latest`, который управляет браузером Playwright.
* Отдельный MCP сервер `playwright-network-monitor` ожидает подключение к браузеру через CDP (`connect_to_browser`), но не может установить соединение.
* MCP Playwright запускает Chromium в своём процессе и не публикует CDP endpoint наружу, из-за чего сторонний монитор не получает доступ к событиям `page.on(...)`.
* Попытка инжектировать JS-перехватчики (`fetch`, XHR) в страницу лишь логирует данные в консоль и не передаёт их в MCP.

### 2. Цель рефакторинга
* Объединить управление браузером и сетевой мониторинг в **одном** MCP сервере.
* Сохранить существующие инструменты автоматизации (навигация, клики, ввод и т.д.).
* Добавить новые инструменты для работы с сетевыми запросами (`get_requests`, `get_request_details`, `clear_requests`, `get_stats`).
* Упростить развёртывание: Cursor должен запускать только наш модифицированный Playwright MCP.

### 3. План действий

#### Шаг 1. Подготовка репозитория
1. Клонировать официальный репозиторий `@playwright/mcp` (например, `git clone https://github.com/microsoft/playwright-mcp`).
2. Установить зависимости (`npm install`) и проверить сборку (`npm run build`) и запуск (`npm start` или эквивалент).

#### Шаг 2. Перенос хранилища и утилит
1. Перенести/адаптировать логику `RequestStorage` из проекта `D:\Projects\Ozon Fresh` в новый репозиторий (например, `src/network/RequestStorage.ts`).
2. Убедиться, что поддерживаются фильтры по URL, методу, статусу, типу ресурса, а также сбор статистики.

#### Шаг 3. Подключение к событиям Playwright
1. В коде сервера, где создаются `browserContext` и страницы, добавить карту `pageId -> page`.
2. Для каждой страницы подписаться на события:
   * `page.on('request', ...)` — сохранять URL, метод, заголовки, `postData` и вспомогательные поля.
   * `page.on('response', ...)` — фиксировать статус, заголовки, тело ответа (`response.text()`), content-type, тайминги (`response.timing()`).
   * `page.on('requestfailed', ...)` — сохранять текст ошибки и статус `0`.
3. Аккуратно обрабатывать ошибки чтения тела (часть ответов может быть недоступна повторно).

#### Шаг 4. Расширение MCP инструментов
1. В обработчике `ListToolsRequest` зарегистрировать новые инструменты, отражающие API Network Monitor.
2. В `CallToolRequest` реализовать:
   * `get_requests` — возвращает список запросов с возможностью фильтрации и лимита.
   * `get_request_details` — выдаёт расширенную информацию по `requestId` (заголовки, тела, тайминги, ошибки).
   * `clear_requests` — очищает все запросы или только по указанной странице.
   * `get_stats` — суммарная статистика по методам, статусам, типам ресурсов и количеству активных мониторов.
3. По необходимости добавить `start_monitoring` / `stop_monitoring`, если нужно вручную управлять подписками.

#### Шаг 5. Сборка и подключение в Cursor
1. Собрать модифицированный сервер (`npm run build` или `tsc`).
2. В файле `C:\Users\<user>\.cursor\mcp.json` заменить блок `Playwright` на запуск локальной сборки, например:
   ```json
   "Playwright": {
     "command": "node",
     "args": ["D:\\Repos\\playwright-mcp\\dist\\index.js"]
   }
   ```
3. Перезапустить Cursor, убедиться, что новый MCP сервер стартует и отображает новые инструменты.

### 4. Ожидаемый результат
* Агент в Cursor управляет браузером через модифицированный Playwright MCP и при необходимости запрашивает сетевые логи через встроенные инструменты.
* Дополнительные серверы (`playwright-network-monitor`) больше не нужны.
* Сетевая информация собирается без обходных путей, доступна для анализа и экспорта.

